<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/base}"
      lang="en">
<head>
    <title th:text="#{sanctions.title}">Sanctions</title>
</head>
<body>
    <div layout:fragment="content" class="container mx-auto px-4 py-4 sm:py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="mb-6 sm:mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white tracking-tight" th:text="#{sanctions.title}">Sanctions</h1>
                <p class="mt-2 text-sm sm:text-base text-gray-600 dark:text-gray-400" th:text="#{sanctions.description}">
                    Apply sanctions to children based on predefined rules.
                </p>
                <!-- Admin Reset Button -->
                <div class="mt-4" sec:authorize="hasRole('ADMIN')">
                    <form th:action="@{/sanctions/reset}" method="post" class="inline-block">
                        <button type="submit"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md
                                       text-white bg-blue-600 hover:bg-blue-700 
                                       focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <span th:text="#{sanctions.manual.reset}">Manual Reset</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Rules Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-6 sm:mb-8">
                <div th:each="rule : ${rules}" 
                     class="bg-white dark:bg-gray-800 shadow rounded-lg p-3 sm:p-4 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center">
                                <svg class="w-4 h-4 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-base sm:text-lg font-medium text-gray-900 dark:text-white" th:text="${rule.description()}">Rule Description</h3>
                            <p class="mt-1 text-sm font-semibold text-red-600 dark:text-red-400">
                                <span th:text="#{sanctions.points}">Points</span>: 
                                <span class="tabular-nums" th:text="${rule.points()}">-5</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Children List -->
            <div class="bg-white dark:bg-gray-800 shadow sm:rounded-lg overflow-hidden p-3 sm:p-4" th:if="${not #lists.isEmpty(children)}">
                <ul role="list" class="space-y-3 sm:space-y-4">
                    <li th:each="child, iterStat : ${children}" 
                        class="p-3 sm:p-4 md:p-6 transition-all duration-300 rounded-lg"
                        th:with="weeklySanction=${not #lists.isEmpty(weeklySanctions) ? weeklySanctions[iterStat.index] : null}"
                        th:classappend="${weeklySanction != null} ? (${weeklySanction.finalPoints >= 15} ? 'bg-green-50 dark:bg-green-900/20' : 
                                     (${weeklySanction.finalPoints >= 10} ? 'bg-yellow-50 dark:bg-yellow-900/20' : 
                                     (${weeklySanction.finalPoints >= 5} ? 'bg-orange-50 dark:bg-orange-900/20' : 
                                     (${weeklySanction.finalPoints >= 0} ? 'bg-red-50 dark:bg-red-900/20' : 
                                     'bg-red-100 dark:bg-red-900/40'))))">
                        <div class="flex flex-col space-y-4">
                            <!-- Child Info -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="h-10 w-10 sm:h-12 sm:w-12 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 dark:from-blue-900 dark:to-blue-800 flex items-center justify-center shadow-inner"
                                             th:classappend="${weeklySanction != null} ? (${weeklySanction.finalPoints >= 15} ? 'from-green-100 to-green-200 dark:from-green-900 dark:to-green-800' : 
                                                          (${weeklySanction.finalPoints >= 10} ? 'from-yellow-100 to-yellow-200 dark:from-yellow-900 dark:to-yellow-800' : 
                                                          (${weeklySanction.finalPoints >= 5} ? 'from-orange-100 to-orange-200 dark:from-orange-900 dark:to-orange-800' : 
                                                          (${weeklySanction.finalPoints >= 0} ? 'from-red-100 to-red-200 dark:from-red-900 dark:to-red-800' : 
                                                          'from-red-200 to-red-300 dark:from-red-800 dark:to-red-700'))))">
                                            <span class="text-base sm:text-lg font-semibold" 
                                                  th:text="${#strings.substring(child.name, 0, 1)}"
                                                  th:classappend="${weeklySanction != null} ? (${weeklySanction.finalPoints >= 15} ? 'text-green-600 dark:text-green-300' : 
                                                               (${weeklySanction.finalPoints >= 10} ? 'text-yellow-600 dark:text-yellow-300' : 
                                                               (${weeklySanction.finalPoints >= 5} ? 'text-orange-600 dark:text-orange-300' : 
                                                               (${weeklySanction.finalPoints >= 0} ? 'text-red-600 dark:text-red-300' : 
                                                               'text-red-700 dark:text-red-200'))))">A</span>
                                        </div>
                                    </div>
                                    <div class="ml-3 sm:ml-4">
                                        <h3 class="text-base sm:text-lg font-medium text-gray-900 dark:text-white" th:text="${child.name}">Child name</h3>
                                        <div th:if="${not #lists.isEmpty(weeklySanctions)}" th:with="weeklySanction=${weeklySanctions[iterStat.index]}" th:id="${'points-' + child.id}" class="mt-1">
                                            <span class="text-sm text-gray-500 dark:text-gray-400" th:text="#{sanctions.points}">Points</span>:
                                            <span class="text-base font-semibold tabular-nums"
                                                  th:classappend="${weeklySanction.finalPoints < 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}"
                                                  th:text="${weeklySanction.finalPoints}">20</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- History Link -->
                                <a th:href="@{/sanctions/history/{id}(id=${child.id})}" 
                                   class="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
                                    <span th:text="#{sanctions.view.history}">View History</span>
                                </a>
                            </div>

                            <!-- Current Week Info -->
                            <div th:if="${not #lists.isEmpty(weeklySanctions)}" th:with="weeklySanction=${weeklySanctions[iterStat.index]}" class="text-sm text-gray-500 dark:text-gray-400 flex justify-between items-center">
                                <span>
                                    <span th:text="#{sanctions.current.week}">Current Week</span>
                                    <span class="ml-2" 
                                          th:text="${#temporals.format(weeklySanction.weekStartDate, 'dd/MM')} + ' - ' + ${#temporals.format(weeklySanction.weekEndDate, 'dd/MM')}">
                                        01/01 - 07/01
                                    </span>
                                </span>
                                <span>
                                    <span th:text="#{sanctions.next.reset}">Next reset:</span>
                                    <span th:text="${#temporals.format(weeklySanction.nextResetDate, 'dd/MM HH:mm')}">08/01 01:00</span>
                                </span>
                            </div>
                            
                            <!-- Sanction Actions -->
                            <div class="flex flex-wrap gap-2 items-center justify-start sm:justify-end mt-2 sm:mt-0">
                                <div th:each="rule : ${rules}" 
                                     class="relative group">
                                    <button th:hx-put="@{/sanctions/{childId}/rule/{ruleCode}(childId=${child.id},ruleCode=${rule.code()})}"
                                            th:hx-target="'#points-' + ${child.id}"
                                            th:hx-swap="'innerHTML'"
                                            class="inline-flex items-center min-w-[3rem] px-3 py-2.5 sm:py-2 border border-transparent text-sm font-medium rounded-md
                                                   text-white bg-red-600 hover:bg-red-700 
                                                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 
                                                   dark:bg-red-500 dark:hover:bg-red-600
                                                   transform transition-all duration-200 hover:scale-105 active:scale-95
                                                   disabled:opacity-50 disabled:cursor-not-allowed
                                                   touch-manipulation"
                                            th:title="${rule.description()}">
                                        <span class="tabular-nums" th:text="${rule.points()}">-5</span>
                                    </button>
                                    <!-- Tooltip -->
                                    <div class="hidden sm:block absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded
                                                opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">
                                        <span th:text="${rule.description()}">Description</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Sanctions -->
                            <div th:if="${not #lists.isEmpty(weeklySanctions) and not #lists.isEmpty(weeklySanctions[iterStat.index].sanctions)}" 
                                 th:with="weeklySanction=${weeklySanctions[iterStat.index]}" 
                                 class="mt-2"
                                 x-data="{ open: false }">
                                <!-- Toggle Header -->
                                <button @click="open = !open"
                                        class="w-full flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-t text-left hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                                    <span class="text-sm font-medium text-gray-900 dark:text-white" th:text="#{sanctions.history}">History</span>
                                    <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform duration-200"
                                         :class="{'rotate-180': open}"
                                         xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <!-- Sanctions List -->
                                <div x-show="open"
                                     x-transition:enter="transition ease-out duration-200"
                                     x-transition:enter-start="opacity-0 transform -translate-y-2"
                                     x-transition:enter-end="opacity-100 transform translate-y-0"
                                     x-transition:leave="transition ease-in duration-150"
                                     x-transition:leave-start="opacity-100 transform translate-y-0"
                                     x-transition:leave-end="opacity-0 transform -translate-y-2"
                                     class="space-y-2 mt-2">
                                    <div th:each="entry : ${weeklySanction.sanctions}" 
                                         class="flex justify-between items-start p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-gray-900 dark:text-white" th:text="${entry.ruleDescription}">Rule description</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                                <span th:text="${entry.appliedByName}">Parent</span> -
                                                <span th:text="${#temporals.format(entry.appliedAt, 'dd/MM HH:mm')}">01/01 14:30</span>
                                            </p>
                                        </div>
                                        <div class="text-sm font-semibold tabular-nums"
                                             th:classappend="${entry.points < 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}">
                                            <span th:text="${entry.points}">-5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- No Children Message -->
            <div th:if="${#lists.isEmpty(children)}" 
                 class="text-center py-8">
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                    <p class="text-gray-500 dark:text-gray-400" th:text="#{sanctions.no.children}">
                        No children found
                    </p>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 